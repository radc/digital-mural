# Digital Mural (React + Node)

A digital signage application built with **Create React App** (frontend) and **Node/Express** (backend).  
It plays **images and videos** from a local folder, lets you **manage media and settings via an /admin panel**, and supports **multi-user authentication** with hashed passwords (stored locally).

> Optimized for kiosk/TV displays: fullscreen, no UI chrome, and keyboard shortcuts to help with maintenance.

---

## ✨ Main Features

- **Media playback** (images & videos) from `public/media/`
  - Images show for a configurable duration (default 10s)
  - Videos play to completion
  - Fit modes per item: `fit | crop | fill | zoom`
  - Schedule per item (days + time window) or global defaults
- **Admin panel (`/admin`)**
  - Upload / delete media files
  - Edit **defaults** and per-file **overrides** (duration, fit, mute, volume, schedule…)
  - **User management** (admins only): create/remove users, reset passwords
  - Any logged-in user can change **own password**
- **Authentication**
  - Local file `data/users.json` with **SHA-256 + salt** password hashing
  - First run auto-creates **admin / 1234**
- **Player**
  - Clean fullscreen “mural” (no progress bars or extra UI)
  - **Keyboard**: `n` (next), `r` (reload), `i` or `u` (show IP overlay with QR to `/admin` for 10s)
  - Optional periodic re-check to enforce fullscreen (if you applied that change earlier)
- **Networking helpers**
  - Endpoint to list **local IPs** (`/api/local-ips`) used by the overlay
  - **HTTP redirect from :80 → :3001** (for simple kiosk setups)
- **Responsive /admin**
  - Desktop: 3 columns → Tablet: 2 → Mobile: 1
  - Touch-friendly controls, sticky header

---

## 🧱 Project Structure (suggested)

```
digital-mural/
├─ server.js                 # Express server (APIs, static, redirect :80→:3001)
├─ package.json
├─ data/
│  └─ users.json             # Users db (auto-created)  — add to .gitignore
├─ public/
│  ├─ index.html             # CRA entry (add Inter font links here)
│  └─ media/                 # Place your videos & images here
│     └─ media.json          # Optional configuration file (defaults & overrides)
├─ src/
│  ├─ index.js
│  ├─ index.css              # Global styles (Inter font, base UI)
│  ├─ App.js
│  ├─ utils/
│  │  └─ schedule.js         # Time-window helper (days/hours)
│  ├─ utils/api.js           # Small JSON/upload helpers
│  ├─ components/
│  │  └─ Player.js           # Fullscreen player (IP/QR overlay with `i`/`u`)
│  └─ pages/
│     └─ Admin.jsx           # Responsive admin panel
└─ build/                    # CRA production build (generated by `npm run build`)
```

> Your server serves **`/`** from `build/` in production, **`/media`** statically from `public/media`, and all **APIs** under `/api/*`.
> Use `/admin` to access the admin UI.

---

## 📦 Requirements

- **Node.js 18+**
- **npm** (or pnpm/yarn)
- Ability to bind to port **3001** (app) and optionally **80** (redirect)
- For `:80` on Linux: run as root **or** grant capability:
  ```bash
  sudo setcap 'cap_net_bind_service=+ep' $(which node)
  ```

---

## 🚀 Setup & Run

### 1) Install dependencies
```bash
npm install
```

If you use the QR overlay in the Player, install:
```bash
npm i qrcode
```

### 2) Development (two servers)

- Backend (port **3001**):
  ```bash
  npm run server
  ```
- Frontend CRA dev server (port **3000**):
  ```bash
  npm start
  ```

Visit: `http://localhost:3000/admin` for live reloading during development.

(Optional) Add a convenience script using **concurrently**:

```jsonc
// package.json
{
  "scripts": {
    "dev": "concurrently \"npm run server\" \"npm start\"",
    "server": "node server.js",
    "prod": "npm run build && node server.js"
  },
  "devDependencies": {
    "concurrently": "^8.2.0"
  }
}
```

### 3) Production (single server)

```bash
npm run build       # creates ./build
node server.js      # serves build/ + APIs on :3001 and redirects :80 -> :3001
```

> Every time you change **frontend** code under `src/**` you must re-run `npm run build` for production.

---

## 🔐 Admin Login & Users

- On first run, the backend creates `data/users.json` with **admin / 1234** (role `admin`).
- Passwords are stored as **SHA-256(salt + password)** + per-user **salt**.
- **Admin capabilities**:
  - Create/remove users
  - Reset others’ passwords
- **All users**:
  - Can log in
  - Can change their **own** password
- API persists to `data/users.json`. You should **ignore** it in git:
  ```gitignore
  data/users.json
  ```

---

## 📁 Media Folder & Allowed Formats

- Put files under `public/media/`
- Allowed **images**: `.jpg, .jpeg, .png, .gif, .bmp, .webp`
- Allowed **videos**: `.mp4, .webm, .ogg, .mov, .avi, .mkv, .wmv, .flv`

> The manifest is built by **reading the folder** and then applying **overrides** (if any) from `media.json`.
> Files not in `media.json` get defaults.

---

## 🧾 `media.json` (optional)

Place a `media.json` file inside `public/media/` to define **defaults** and per-file **overrides**.  
Example:

```jsonc
{
  "defaults": {
    "imageDurationMs": 10000,
    "fitMode": "fit",
    "bgColor": "#000000",
    "mute": true,
    "volume": 1.0,
    "schedule": {
      "days": ["mon","tue","wed","thu","fri","sat","sun"],
      "start": "00:00",
      "end": "23:59",
      "tz": "America/Sao_Paulo"
    }
  },
  "items": [
    { "src": "video1.mp4", "type": "video", "fitMode": "crop", "mute": false, "volume": 0.8 },
    { "src": "foto1.jpg",  "type": "image", "imageDurationMs": 15000, "fitMode": "fit" }
  ]
}
```

### Fields
- `imageDurationMs`: how long images stay on screen (ms)
- `fitMode`: `fit | crop | fill | zoom` (mapped to CSS `object-fit`: contain/cover/fill/cover)
- `bgColor`: background during playback
- `mute` / `volume`: defaults for videos
- `schedule`: optional time window (days + `start`/`end`, 24h, local time)

> Overrides in `items[]` only apply if the filename exists in the folder.

---

## 🎛 Admin Panel (/admin)

- **Files**: upload/delete assets under `public/media`
- **Defaults**: set global defaults applied to every file (when not overridden)
- **Per-file override**: pick a file and customize duration, fit mode, mute/volume, schedule…
- **Users**: (admins only) list users, reset passwords, delete users, create new users
- **Change my password**: any logged user can change own password

The Admin UI is **responsive** and touch-friendly; it uses a sticky header and adapts columns by screen width.

---

## 🎬 Player

- Starts fullscreen (user action may be required by the browser; click to enter)
- Clean screen (no toolbars, progress bars)
- Plays videos fully; images for configured duration
- Auto-refreshes manifest every 60s (or refresh manually with `r`)

**Keyboard shortcuts**
- `n` → next item
- `r` → reload page
- `i` or `u` → show local IP overlay for **10s**  
  - Overlay shows discovered IPs and a **QR Code** linking to `http://<ip>:<port>/admin`

> If you implemented the 20s watchdog earlier, the Player re-requests fullscreen periodically.

---

## 🌐 Local IP Overlay

Backend endpoint:
- `GET /api/local-ips` → `{ "ips": ["192.168.0.10", "10.0.0.5", ...] }`

Frontend overlay:
- Press `i` or `u` in the Player to show IPs + QR (10 seconds)
- The QR targets `/admin` on the first IP found
- Requires `qrcode` package installed (`npm i qrcode`)

---

## 🔌 Ports & Redirect

- App serves on **:3001**
- A small HTTP server also listens on **:80** and **redirects** to `http://<host>:3001`
- On Linux, bind to :80 by either:
  - Running as root (ok in controlled environments), or
  - Granting capability to Node:
    ```bash
    sudo setcap 'cap_net_bind_service=+ep' $(which node)
    ```

> HTTPS/443 redirect is intentionally **not used** here (kept simple for local/kiosk usage).

---

## 🔤 Fonts & UI

The project uses the **Inter** font. Add these lines to `public/index.html` inside `<head>`:

```html
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
```

Global styles are in `src/index.css`.

---

## 🛠 Troubleshooting

- **Admin changes don’t appear** after editing React code
  - Run `npm run build` and restart `node server.js` (the server serves `build/`)
- **`/admin` doesn’t show Users section**
  - Check `GET /api/admin/state` returns `currentUser.role: "admin"` and `users: [...]`
  - Rebuild the frontend (`npm run build`)
- **`ReferenceError: req is not defined`** in server
  - Ensure the handler signature is `(req, res)` and not `(_req, res)` where you use `req`
- **`URIError: Failed to decode param '/%PUBLIC_URL%/...'`**
  - Ensure you’re serving the CRA build correctly and didn’t hardcode `%PUBLIC_URL%` in routes
- **Can’t bind to port 80**
  - Use `sudo setcap 'cap_net_bind_service=+ep' $(which node)` or run as root
- **QR overlay not showing**
  - Install the dependency: `npm i qrcode`
- **No media showing**
  - Ensure files are in `public/media/` with allowed extensions
  - If `media.json` exists, check JSON validity

---

## 🧪 API Summary

- Auth
  - `POST /api/login` `{ username, password }`
  - `POST /api/logout`
  - `GET /api/me` → `{ user: { username, role } }`
  - `POST /api/me/password` `{ currentPassword, newPassword }`
- Users (admin)
  - `GET /api/users` → list users
  - `POST /api/users` `{ username, password, role }`
  - `POST /api/users/password` `{ username, newPassword }`
  - `DELETE /api/users/:username`
- Media/Admin
  - `GET /api/admin/state` → `defaults, overrides, files, currentUser, users?`
  - `POST /api/admin/defaults` → update defaults
  - `POST /api/admin/override` → upsert override `{ src, ... }`
  - `DELETE /api/admin/override/:src`
  - `POST /api/admin/upload` (multipart `file`)
  - `DELETE /api/admin/file/:src`
- Player/Utils
  - `GET /api/manifest` → merges folder listing + overrides
  - `GET /api/local-ips` → local IPv4 list
  - Static `/media/*` → serves actual files

---

## 🧹 Git Ignore (suggested)

```
# build output
/build

# local users db (contains hashes/salts)
data/users.json

# OS
.DS_Store

# media heavy files (optional)
*.mp4
*.webm
*.mov
*.avi
*.mkv
*.wmv
*.flv
```

> If you version your media, remove those globs. Otherwise it keeps the repo light.

---

## 📜 License

MIT — use freely in your projects and adapt as needed.
