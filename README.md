# Digital Mural (React + Node)

A digital signage application built with **Create React App** (frontend) and **Node/Express** (backend).
It plays **images, videos, and HTML notices** from a local folder, lets you **manage media and settings via an /admin panel**, and supports **multi-user authentication** with salted SHA-256 password hashes stored locally.

> Optimized for kiosk/TV displays: fullscreen, no UI chrome, keyboard shortcuts for maintenance, and an IP + QR overlay (press `i` or `u`).

---

## ‚ú® Main Features

- **Media playback** from `public/media/`
  - Images show for a configurable duration (default 10s)
  - Videos play to completion
  - Optional HTML notices (generated/edited from Admin) are rendered in the Player
  - Fit modes: `fit | crop | fill | zoom`
  - Schedule per item (days + time window) or global defaults
- **Admin panel (`/admin`)**
  - Upload / delete media files
  - Edit **defaults** and per-file **overrides** (duration, fit, mute, volume, schedule‚Ä¶)
  - Create **HTML notices** (with live preview) or edit existing `.html` files
  - **User management** (admins): create/remove users, reset passwords
  - Any logged-in user can change **own password**
- **Authentication**
  - Local DB `data/users.json` (auto-created on first run) with **salted SHA-256** hashes
  - First run auto-creates **admin / 1234**
- **Player**
  - Clean fullscreen ‚Äúmural‚Äù (no progress bars or extra UI)
  - **Keyboard**: `n` (next), `r` (reload), `i` / `u` (IP overlay with QR to `/admin`, 10s)
  - Auto-refresh of manifest every 60s
  - Optional watchdog that re-applies fullscreen periodically
- **Networking helpers**
  - Endpoint with local IPs for overlay
  - Simple HTTP redirect **:80 ‚Üí :3001** for controlled kiosk setups

---

## üß± Project Structure (suggested)

```
digital-mural/
‚îú‚îÄ server.js                 # Express server (APIs, static, redirect :80‚Üí:3001)
‚îú‚îÄ ecosystem.config.js       # PM2 app configuration
‚îú‚îÄ package.json
‚îú‚îÄ data/
‚îÇ  ‚îî‚îÄ users.json             # Users DB (auto-created) ‚Äî add to .gitignore
‚îú‚îÄ public/
‚îÇ  ‚îú‚îÄ index.html             # CRA entry (consider adding Inter font links)
‚îÇ  ‚îî‚îÄ media/                 # Place your videos, images, and .html notices here
‚îÇ     ‚îî‚îÄ media.json          # Optional configuration file (defaults & overrides)
‚îú‚îÄ src/
‚îÇ  ‚îú‚îÄ index.js
‚îÇ  ‚îú‚îÄ index.css              # Global styles
‚îÇ  ‚îú‚îÄ App.js
‚îÇ  ‚îú‚îÄ utils/
‚îÇ  ‚îÇ  ‚îú‚îÄ api.js              # Small JSON/upload helpers
‚îÇ  ‚îÇ  ‚îî‚îÄ schedule.js         # Time-window helper (days/hours)
‚îÇ  ‚îú‚îÄ components/
‚îÇ  ‚îÇ  ‚îî‚îÄ Player.js           # Fullscreen player (IP/QR overlay with `i`/`u`)
‚îÇ  ‚îî‚îÄ pages/
‚îÇ     ‚îî‚îÄ Admin.jsx           # Responsive admin panel
‚îî‚îÄ build/                    # CRA production build (generated by `npm run build`)
```

> In production, the server serves `build/` and exposes APIs under `/api/*`. The `/media/*` files are served statically from `public/media/`.

---

## üì¶ Requirements

- **Node.js 18+**
- **npm** (or pnpm/yarn)
- Ability to bind to **port 3001** (app) and optionally **80** (redirect)
- For port **80** on Linux, either run as root or grant capability:
  ```bash
  sudo setcap 'cap_net_bind_service=+ep' $(which node)
  ```

---

## üßë‚Äçüíª Development (two processes)

```bash
npm ci
npm run server      # backend on :3001
npm start           # CRA dev server on :3000
```

Visit: `http://localhost:3000/admin` for live reload during development.

Optional convenience (already in package.json):
```bash
npm run dev         # runs backend + CRA together (concurrently)
```

---

## üöÄ Production (PM2)

### Install PM2 globally (recommended)
> On Linux you might need `sudo`.
```bash
npm i -g pm2
```

### Start the app
```bash
npm ci
npm run prod     # builds the frontend and runs: pm2 start ecosystem.config.js
```

This will:
- Build the CRA app into `./build`
- Start the server with **PM2** using `ecosystem.config.js` (app name: `mural-server` by default)

### Useful PM2 commands
```bash
pm2 status
pm2 logs mural-server --lines 100
pm2 restart mural-server
pm2 stop mural-server
pm2 delete mural-server
```

### Start on boot (auto-restart on crash)
```bash
pm2 startup     # follow the printed command (may require sudo)
pm2 save        # saves the current process list to restore at boot
```

### (Optional) Log rotation
```bash
pm2 install pm2-logrotate
pm2 set pm2-logrotate:max_size 10M
pm2 set pm2-logrotate:retain 30
pm2 set pm2-logrotate:compress true
pm2 save
```

> If your server code listens on **:80** to redirect to :3001, ensure Node can bind to :80 (see ‚ÄúRequirements‚Äù above).

---

## üñ•Ô∏è Kiosk Auto-Start (Firefox in kiosk mode)

For a simple all-in-one setup (backend and frontend on the same PC), create a small script that:
1) builds & starts the server with PM2,  
2) waits until the app is serving, and  
3) launches **Firefox in kiosk mode** to `http://localhost:3001` (or directly to `/admin`).

Create `kiosk-start.sh` and make it executable:
```bash
#!/usr/bin/env bash
set -euo pipefail

APP_DIR="/path/to/digital-mural"   # <-- change this
APP_URL="http://localhost:3001"    # or "http://localhost:3001/admin"

cd "$APP_DIR"

# Install deps (first boot) and build+start with PM2
npm ci --omit=dev
npm run prod   # runs build + pm2 start ecosystem.config.js

# Wait until the server responds (timeout ~60s)
echo "Waiting for $APP_URL ..."
for i in {1..60}; do
  if curl -fsS "$APP_URL" >/dev/null 2>&1; then
    echo "Server is up!"
    break
  fi
  sleep 1
done

# Launch Firefox in kiosk mode
# --kiosk hides chrome; --new-window avoids reusing a previous session window
/usr/bin/firefox --kiosk --new-window "$APP_URL" &>/dev/null &
```

Make it executable:
```bash
chmod +x kiosk-start.sh
```

### Autostart on boot

**Option A) systemd service (recommended)**

Create `/etc/systemd/system/digital-mural.service`:
```ini
[Unit]
Description=Digital Mural Kiosk
After=network-online.target graphical.target
Wants=network-online.target

[Service]
Type=exec
User=<your_user>                # set your username
Environment=DISPLAY=:0         # ensure X/Wayland display is available
Environment=XDG_RUNTIME_DIR=/run/user/%U
WorkingDirectory=/path/to/digital-mural
ExecStart=/path/to/digital-mural/kiosk-start.sh
Restart=always
RestartSec=5

[Install]
WantedBy=graphical.target
```

Then:
```bash
sudo systemctl daemon-reload
sudo systemctl enable digital-mural.service
sudo systemctl start digital-mural.service
```

**Option B) @reboot crontab (simpler)**

```bash
crontab -e
# add a line like:
@reboot /path/to/digital-mural/kiosk-start.sh
```

> Tip: If you don‚Äôt want to rebuild on every boot (to speed up), replace `npm run prod` in the script with:
```bash
npm run build        # only when frontend changed
pm2 start ecosystem.config.js || pm2 restart mural-server
```

---

## üîê Admin Login & Users

- On first run, the backend creates `data/users.json` with **admin / 1234** (role `admin`).
- Passwords are stored as **SHA-256(salt + password)** + per-user **salt**.
- **Admin** can create/remove users and reset passwords.
- **All users** can change **own password**.
- Add `data/users.json` to `.gitignore` (it contains sensitive hashes).

---

## üìÅ Media Folder & Allowed Formats

- Put files under `public/media/`
- Allowed **images**: `.jpg, .jpeg, .png, .gif, .bmp, .webp, .svg`
- Allowed **videos**: `.mp4, .webm, .ogg` (others depend on your browser/codec support)
- Allowed **notices**: `.html`

> The Player builds its playlist by reading the folder and then applying per-file overrides. Files not present in the JSON inherit defaults.

---

## üßæ Optional `media.json`

Place `public/media/media.json` to define **defaults** and per-file **overrides**.  
Example:

```jsonc
{
  "defaults": {
    "imageDurationMs": 10000,
    "htmlDurationMs": 15000,
    "fitMode": "fit",
    "bgColor": "#000000",
    "mute": true,
    "volume": 1.0,
    "schedule": {
      "days": ["mon","tue","wed","thu","fri","sat","sun"],
      "start": "00:00",
      "end": "23:59",
      "tz": "America/Sao_Paulo"
    }
  },
  "items": [
    { "src": "video1.mp4", "type": "video", "fitMode": "crop", "mute": false, "volume": 0.8 },
    { "src": "foto1.jpg",  "type": "image", "imageDurationMs": 15000, "fitMode": "fit" }
  ]
}
```

---

## üß™ API Summary

- Auth
  - `POST /api/login` `{ username, password }`
  - `POST /api/logout`
  - `GET /api/me` ‚Üí `{ user: { username, role } }`
  - `POST /api/me/password` `{ currentPassword, newPassword }`
- Users (admin)
  - `GET /api/users`
  - `POST /api/users` `{ username, password, role }`
  - `POST /api/users/password` `{ username, newPassword }`
  - `DELETE /api/users/:username`
- Media/Admin
  - `GET /api/admin/state` ‚Üí `defaults, overrides, files, currentUser, users?`
  - `POST /api/admin/defaults`
  - `POST /api/admin/override`
  - `DELETE /api/admin/override/:src`
  - `POST /api/admin/upload` (multipart `file`)
  - `DELETE /api/admin/file/:src`
  - `POST /api/admin/html` / `GET /api/admin/html/:name` / `POST /api/admin/html-save` / `POST /api/admin/duplicate`
- Player/Utils
  - `GET /api/manifest`
  - `GET /api/local-ip`
  - `GET /api/qr.svg?data=...` (and optional `/api/qr?data=...` PNG)
  - Static `/media/*`

---

## üßπ .gitignore (suggested)

```
# build output
/build

# local users db (contains password hashes)
data/users.json

# OS junk
.DS_Store

# Optional: keep repo light by ignoring large videos
*.mp4
*.webm
*.mov
*.avi
*.mkv
*.wmv
*.flv
```
